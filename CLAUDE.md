# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**zod-vue-i18n** is a library that integrates [Zod](https://zod.dev) validation error messages with [vue-i18n](https://vue-i18n.intlify.dev/) for Vue 3 applications. It translates Zod's default validation errors into localized messages via vue-i18n.

The library maintains **dual support** for both Zod v3 and v4 through separate entry points, allowing consumers to import the appropriate version for their Zod installation.

## Build Tools & Commands

### Development Commands

```bash
# Type check (no output generation)
pnpm type-check

# Lint code with oxlint (fast, Rust-based)
pnpm lint
pnpm lint:fix

# Run tests with vitest
pnpm test                    # Interactive watch mode
pnpm test --run             # Single run

# Build the library
pnpm build                  # Uses tsdown: compiles, generates types, updates exports
```

### Build Architecture

The project uses **tsdown** (powered by Rolldown) as the build tool:
- Single command bundles code, generates type definitions, and updates package.json exports
- Targets ESM format only
- Auto-generates `exports`, `main`, `module`, and `types` fields in package.json
- No manual export field maintenance needed

**Configured entry points:**
- `src/index.ts` → outputs to `dist/index.js` (Zod v3)
- `src/v4/index.ts` → outputs to `dist/v4.js` (Zod v4)

## Project Structure

### `/src` - Source Code

**Entry points:**
- `src/index.ts` - Default export targeting Zod v3
- `src/v4/index.ts` - v4-specific export for Zod v4
- `src/types.ts` - TypeScript type definitions
- `src/utils.ts` - Helper functions for i18n translation lookup

Both entry points export:
- `makeZodI18nMap(i18n)` - Factory function creating a Zod error map
- `zDate` - Pre-configured Zod date validator

**Key Implementation Details:**
- Each version has a large switch statement handling all Zod error codes
- Supports custom i18n via `issue.params.i18n`
- Handles pluralization via vue-i18n's built-in plural support
- Uses `WithPath` suffix in message keys for object property error customization

### `/test` - Tests

- `test/makeZodI18nMap.test.ts` - v3 tests
- `test/v4/makeZodI18nMap.test.ts` - v4 tests

Tests verify:
- `makeZodI18nMap` returns a function
- Correct message translation from i18n instance
- Pluralization with `count` parameter

### `/locales` - Translation Files

Pre-built JSON files with Zod error messages:
- `en.json`, `it.json`, `ptBR.json` (v3)
- `v4/en.json`, `v4/it.json`, `v4/ptBR.json` (v4)

These are published as package exports and can be imported directly:
```typescript
import en from 'zod-vue-i18n/locales/en.json'
import en from 'zod-vue-i18n/locales/v4/en.json'  // For Zod v4
```

### `/dist` - Build Output

Generated by `pnpm build`:
- `index.js` / `index.d.ts` (v3 build)
- `v4.js` / `v4.d.ts` (v4 build)
- Utility chunks (auto-generated)

## Key Architecture Patterns

### Dual Version Support

The library maintains **parallel implementations** for Zod v3 and v4:
- Different error code names between versions (e.g., `invalid_type` vs `invalid_value`)
- Different issue properties (e.g., `issue.received` vs `issue.input`)
- Separate test suites mirroring each other
- Separate locale files (though mostly identical)

When making changes, **update both versions** unless the change is version-specific.

### Error Code Handling

Both `src/index.ts` and `src/v4/index.ts` contain large switch statements mapping Zod error codes to i18n message lookup patterns:
- Error code → message key pattern
- Extraction of validation parameters (minimum, maximum, expected type, etc.)
- Fallback message handling if i18n key doesn't exist

### Message Translation Flow

1. Zod validation fails, calls the error map created by `makeZodI18nMap`
2. Error map handler extracts error code and parameters
3. Constructs i18n message key path (e.g., `errors.tooSmall.string.inclusive`)
4. Looks up message in i18n instance via `translateLabelFactory`
5. Returns localized error message with interpolated parameters

### Pluralization

Messages use vue-i18n's pipe-based pluralization syntax:
```json
{
  "exact": "String must be exactly {{minimum}} character | String must be exactly {{minimum}} characters"
}
```

The `retrieveCount()` utility extracts the plural count from validation parameters (minimum, maximum, count, etc.).

## Development Guidelines

### When Adding New Error Codes

1. Add handling in **both** `src/index.ts` and `src/v4/index.ts`
2. Extract parameters from the error issue
3. Construct the message key using the error code pattern
4. Call `translateLabel` with appropriate parameters
5. Add test cases in both `test/makeZodI18nMap.test.ts` and `test/v4/makeZodI18nMap.test.ts`

### When Updating Locale Files

- Update both v3 and v4 versions in `/locales` and `/locales/v4`
- Use pipe syntax for pluralization: `"singular | plural"`
- Parameter interpolation uses double braces: `{{paramName}}`

### Testing a Single Test File

```bash
pnpm test test/makeZodI18nMap.test.ts
```

## Tooling Notes

- **Linter**: oxlint (Rust-based, much faster than eslint)
- **Test Framework**: Vitest (Jest-compatible, faster)
- **Build Tool**: tsdown with Rolldown
- **Code Style**: Single quotes, no semicolons, 4-space indentation, smart tabs

All tools are configured to work with TypeScript and Vue 3.

## Important Files to Know

- `tsdown.config.ts` - Build configuration with entry points
- `vitest.config.ts` - Test runner configuration
- `oxlint.json` - Linter rules
- `tsconfig.json` - TypeScript compilation settings (strict mode, ESNext target)
- `package.json` - Auto-generated exports via tsdown build
